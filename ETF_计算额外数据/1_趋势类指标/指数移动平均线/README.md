# 指数移动平均线 (Exponential Moving Average - EMA) - 重构版

## 🎯 项目概述
指数移动平均线是对简单移动平均线的改进，通过指数加权的方式给予近期价格更高权重，使指标对价格变化更加敏感。**专注于中短期交易信号**。

**本项目已完成架构重构，采用模块化设计，支持智能缓存和并行处理。**

## 🎯 核心指标（中短期专版）

### 中短期EMA组合
- **EMA12**: 12日指数移动平均线 - MACD快线，短期趋势指标
- **EMA26**: 26日指数移动平均线 - MACD慢线，中期趋势指标

### 🆕 EMA差值指标
- **EMA_DIFF_12_26**: EMA12 - EMA26 (核心动量指标，MACD基础)
- **EMA_DIFF_12_26_PCT**: 相对差值百分比

## 🔬 科学计算公式
```
EMA(today) = α × Price(today) + (1-α) × EMA(yesterday)

其中：
α = 2 / (n + 1) 为平滑因子（科学权重系数）
n = 周期数

EMA12: α = 2/(12+1) = 0.1538
EMA26: α = 2/(26+1) = 0.0741
```

## ⚡ 与SMA对比优势

### 🚀 EMA中短期优势
- **反应速度快**: 对价格变化更敏感，适合中短期交易
- **减少滞后**: 能更快捕捉趋势转折点
- **权重递减**: 近期数据影响更大，符合市场心理
- **动量敏感**: EMA差值能快速反映动量变化

### 📊 中短期特点
- **快速响应**: 比SMA提前1-3天捕捉信号
- **MACD基础**: EMA12-EMA26是MACD的核心计算
- **趋势确认**: 价格与EMA位置关系明确多空方向

## 🎯 中短期应用策略

### 1. 快速趋势确认
- **价格位置**: 价格在EMA12上方为短期多头，在EMA26上方为中期多头
- **EMA斜率**: EMA12上升确认短期上涨，EMA26上升确认中期上涨
- **双重确认**: 价格 > EMA12 > EMA26 为强势多头排列

### 2. 动量捕捉（核心策略）
- **EMA金叉**: EMA12上穿EMA26，买入信号
- **EMA死叉**: EMA12下穿EMA26，卖出信号
- **差值扩大**: EMA12-EMA26差值增大，动量增强

### 3. 动态支撑阻力
- **EMA12**: 短期动态支撑阻力位（适合日内交易）
- **EMA26**: 中期动态支撑阻力位（适合波段交易）

### 4. MACD预备计算
- **DIF线**: EMA12 - EMA26 (MACD的核心组成)
- **动量强度**: 差值绝对值大小反映趋势强度

## ✅ 中短期最佳使用场景
- 🎯 **日内交易**: 基于EMA12的快速信号
- 🎯 **波段交易**: 基于EMA12-EMA26交叉
- 🎯 **MACD准备**: 为MACD指标计算提供基础
- 🎯 **趋势跟踪**: 中短期趋势识别和确认

## ❌ 避免使用场景
- 强烈震荡的横盘市场（假信号较多）
- 重大消息面冲击期间（技术分析失效）

## 📊 输出字段（标准化版 v2.1）
- `code`: ETF代码（清理格式，无交易所后缀）
- `date`: 交易日期（YYYY-MM-DD格式）
- `EMA_12`: 12日指数移动平均线（短期，8位小数精度）
- `EMA_26`: 26日指数移动平均线（中期，8位小数精度）
- `EMA_DIFF_12_26`: EMA差值（动量指标，8位小数精度）
- `EMA_DIFF_12_26_PCT`: EMA差值百分比（8位小数精度）
- `EMA12_MOMENTUM`: EMA12动量（日变化，8位小数精度）

## 🚀 系统特性（重构版新增）

### 🏗️ 模块化架构
- **基础设施层**: 配置、数据读取、缓存管理、文件管理
- **计算引擎层**: EMA核心算法、历史数据计算器
- **控制器层**: ETF处理器、批量处理器、主控制器
- **输出层**: 自动格式化和文件保存

### ⚡ 智能缓存系统
- **增量更新**: 智能检测数据变化，只计算新增部分
- **缓存命中**: 相同数据直接从缓存读取，速度提升10-100倍
- **数据一致性**: 缓存与输出格式完全一致
- **Meta管理**: 详细的处理统计和时间记录

### 🔧 自动初始化
- **目录自动创建**: 系统自动创建必要的目录结构
- **智能目录管理**: 按门槛自动组织输出文件
- **容错恢复**: 即使删除目录后也能自动重新创建

### 🚀 并行处理支持
- **多线程处理**: 支持并发计算多个ETF
- **性能优化**: 大批量数据自动启用并行模式
- **可配置**: 支持自定义并发线程数

### 📁 数据格式统一
- **纯净输出**: 输出文件只包含EMA计算字段，无原始价格数据
- **格式一致**: data文件和cache文件格式完全一致
- **代码清理**: ETF代码统一清理，无交易所后缀

## 📁 目录结构

系统自动生成有序的目录结构：

```
data/
├── 3000万门槛/              # 3000万门槛ETF计算结果
└── 5000万门槛/              # 5000万门槛ETF计算结果

cache/
├── 3000万门槛/              # 缓存文件
├── 5000万门槛/              # 缓存文件
└── meta/
    ├── cache_global_meta.json      # 全局缓存元数据
    ├── 3000万门槛_meta.json        # 3000万门槛元数据
    └── 5000万门槛_meta.json        # 5000万门槛元数据
```

**🔧 自动初始化特性**：
- 系统首次运行时自动创建完整的目录结构
- 自动生成meta文件记录缓存状态和处理历史
- 即使手动删除`data/`、`cache/`或`meta/`目录，系统也能自动重新创建

## 🛠️ 使用方法

### 基础使用
```python
from ema_calculator.controllers.main_controller import EMAMainController

# 创建控制器
controller = EMAMainController(
    adj_type='前复权',
    ema_periods=[12, 26], 
    enable_cache=True,
    performance_mode=False
)

# 批量计算3000万门槛ETF
result = controller.calculate_and_save_screening_results(
    thresholds=['3000万门槛', '5000万门槛']
)
```

### 单个ETF计算
```python
# 计算单个ETF
result = controller.calculate_single_etf('159201', save_result=True)

# 快速分析
analysis = controller.quick_analysis('159201', include_historical=True)
```

### 系统状态检查
```python
# 显示系统状态
controller.show_system_status()

# 获取可用ETF列表
etfs = controller.get_available_etfs()
```

## 📈 性能优化

### 缓存命中效果
- **首次计算**: 正常处理时间
- **缓存命中**: 速度提升10-100倍
- **增量更新**: 只计算新增数据，大幅提升效率

### 并行处理效果
- **小数据集**: 自动使用串行处理（优化开销）
- **大数据集**: 自动启用并行处理（4个工作线程）
- **性能模式**: 可启用性能模式关闭详细输出

## 🔧 技术实现

### EMA计算算法
- **科学公式**: 严格按照 `EMA = α × Price + (1-α) × EMA_prev` 实现
- **精度保证**: 使用pandas的ewm方法确保计算精度
- **性能优化**: 预计算平滑因子，避免重复计算

### 缓存机制
- **日期比较**: 智能比较源文件和缓存文件的最新日期
- **格式统一**: 自动处理不同日期格式的比较
- **有效性检查**: 多层验证确保缓存数据完整性

### 数据处理
- **日期标准化**: 统一处理各种日期格式
- **错误处理**: 完善的异常处理和错误恢复
- **内存优化**: 避免大数据集内存溢出

## 故障排除

### 常见问题
1. **目录或文件缺失**：系统会自动创建，无需手动操作
2. **缓存不一致**：删除`cache/`目录后重新运行即可
3. **meta文件损坏**：系统会自动检测并重新创建

### 完全重置
如需完全重置系统状态：
```bash
rm -rf data/ cache/
python ema_main.py --status  # 系统会自动重新创建所有目录
```

## 更新日志
- v2.1.0: 标准化版发布，字段命名英文化，精度统一8位小数，日期ISO格式
- v2.0.1: 新增自动目录创建和meta文件管理功能  
- v2.0.0: 重构版发布，模块化架构，智能缓存
- v1.0.0: 基础版本，EMA计算