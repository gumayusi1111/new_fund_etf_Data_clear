# MACD指标组合系统 - 重构版

## 系统概述
高性能的MACD指标计算系统，采用模块化架构，支持智能缓存和增量计算。MACD是最重要的趋势跟踪和动量指标之一，通过快慢EMA的差值变化来识别趋势和动量。

## 核心特性
- 🚀 **三参数配置**: 标准/敏感/平滑三种MACD参数组合
- 📊 **双门槛处理**: 3000万/5000万门槛ETF分别处理  
- 🗂️ **智能缓存**: 增量计算，避免重复计算
- 📁 **目录组织**: 按参数和门槛自动组织输出文件
- 🔧 **自动初始化**: 自动创建目录结构和meta文件，即使删除后也能重新创建
- ⚡ **高性能**: 批量处理，支持大规模ETF计算

## 技术指标组件

### 核心计算
- **EMA_Fast**: 快速指数移动平均
- **EMA_Slow**: 慢速指数移动平均  
- **DIF**: 差离值 (EMA_Fast - EMA_Slow)
- **DEA**: 信号线 (DIF的9日EMA)
- **MACD_Bar**: MACD柱状图 (DIF - DEA)

### 计算公式
```
EMA_Fast = EMA(Close, fast_period)
EMA_Slow = EMA(Close, slow_period)
DIF = EMA_Fast - EMA_Slow
DEA = EMA(DIF, signal_period)
MACD_Bar = DIF - DEA
```

## 参数配置

基于学术研究和市场实践，系统提供三种优化的参数组合：

### 1. 标准参数 (Standard)
- **快线周期**: 12日
- **慢线周期**: 26日
- **信号线周期**: 9日
- **适用**: 通用场景，平衡灵敏度和稳定性

### 2. 敏感参数 (Sensitive)  
- **快线周期**: 8日
- **慢线周期**: 17日
- **信号线周期**: 9日
- **适用**: 短期交易，更快响应价格变化

### 3. 平滑参数 (Smooth)
- **快线周期**: 19日
- **慢线周期**: 39日
- **信号线周期**: 9日
- **适用**: 长期分析，减少噪声干扰

## 目录结构

系统自动生成有序的目录结构：

```
data/
├── 3000万门槛/
│   ├── 标准/          # 标准参数(12,26,9)计算结果
│   ├── 敏感/          # 敏感参数(8,17,9)计算结果
│   └── 平滑/          # 平滑参数(19,39,9)计算结果
└── 5000万门槛/
    ├── 标准/
    ├── 敏感/
    └── 平滑/

cache/
├── 3000万门槛/
│   ├── 标准/          # 缓存文件
│   ├── 敏感/
│   └── 平滑/
├── 5000万门槛/
│   ├── 标准/
│   ├── 敏感/
│   └── 平滑/
└── meta/
    ├── cache_global_meta.json      # 全局缓存元数据
    ├── 3000万门槛_meta.json        # 3000万门槛元数据
    └── 5000万门槛_meta.json        # 5000万门槛元数据
```

**🔧 自动初始化特性**：
- 系统首次运行时自动创建完整的目录结构
- 自动生成meta文件记录缓存状态和处理历史
- 即使手动删除`data/`、`cache/`或`meta/`目录，系统也能自动重新创建

## 使用方法

### 快速开始
```bash
python macd_main.py                          # 默认：标准参数计算所有ETF
echo "0" | python macd_main.py               # 自动批量处理所有参数组合
```

### 单个ETF计算
```bash
python macd_main.py --etf 159303.SZ         # 计算指定ETF
python macd_main.py --etf 159303.SZ --parameter-set sensitive  # 使用敏感参数
```

### 快速分析
```bash
python macd_main.py --quick 159303.SZ       # 快速分析（不保存文件）
python macd_main.py --status                # 查看系统状态
python macd_main.py --list                  # 列出可用ETF
```

### 参数选项
```bash
--parameter-set {standard|sensitive|smooth} # 选择参数组合
--adj-type {前复权|后复权|除权}              # 复权类型
--max-etfs N                                # 限制处理ETF数量
--verbose                                   # 详细输出
```

## 输出格式

每个CSV文件包含以下字段：
- `date`: 日期
- `code`: ETF代码
- `ema_fast`: 快速EMA值
- `ema_slow`: 慢速EMA值
- `dif`: DIF差离值
- `dea`: DEA信号线值
- `macd_bar`: MACD柱状图值
- `calc_time`: 计算时间

## 性能特性

### 智能缓存
- 自动检测数据更新，只计算新增数据
- 支持参数级别的缓存隔离
- 缓存命中率提升处理速度80%+

### 增量计算
- 基于最后计算日期的增量更新
- 避免全量重复计算历史数据
- 显著提升大规模ETF处理效率

### 自动管理
- 系统启动时自动创建必要目录和文件
- 智能检测并恢复缺失的meta文件
- 零配置运行，即开即用

### 批量处理
- 支持三参数×双门槛的6种组合批量计算
- 并行友好的架构设计
- 进度追踪和错误处理

## 技术架构

```
macd_calculator/
├── controllers/        # 控制层
├── engines/           # 计算引擎
├── infrastructure/    # 基础设施
├── outputs/          # 输出处理
└── interfaces/       # 接口定义
```

## 系统要求
- Python 3.7+
- pandas, numpy
- 充足的磁盘空间用于缓存

## 更新日志
- v2.0.1: 新增自动目录创建和meta文件管理功能
- v2.0.0: 重构版发布，模块化架构，智能缓存
- v1.0.0: 基础版本，三参数MACD计算

## 故障排除

### 常见问题
1. **目录或文件缺失**：系统会自动创建，无需手动操作
2. **缓存不一致**：删除`cache/`目录后重新运行即可
3. **meta文件损坏**：系统会自动检测并重新创建

### 完全重置
如需完全重置系统状态：
```bash
rm -rf data/ cache/
python macd_main.py --status  # 系统会自动重新创建所有目录
``` 