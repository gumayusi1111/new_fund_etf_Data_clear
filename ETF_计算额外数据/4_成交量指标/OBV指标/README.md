# 📊 OBV指标系统 (能量潮指标) 

## 🎯 指标概述
OBV (On-Balance Volume) 由美国技术分析大师约瑟夫·格兰维尔(Joseph Granville)于1963年在其著作《股市利润的新钥匙》中首次提出。该指标通过累计成交量变化来反映资金流向，基于"量在价先"的核心理念，是识别主力资金动向和验证价格趋势的重要工具。

## 📈 理论基础

### 🔬 核心原理
**量在价先理论**: 成交量往往先于价格发生变化，主力资金的进出会在成交量上留下痕迹。OBV通过累积每日正负成交量，构建资金流向的连续性指标，能够提前捕捉趋势转换信号。

### 📊 数学基础
```python
# OBV计算公式 (标准威尔德方法)
if 收盘价[i] > 收盘价[i-1]:
    OBV[i] = OBV[i-1] + 成交量[i]    # 价格上涨，成交量计为正
elif 收盘价[i] < 收盘价[i-1]:
    OBV[i] = OBV[i-1] - 成交量[i]    # 价格下跌，成交量计为负
else:
    OBV[i] = OBV[i-1]                # 价格平盘，成交量不计入
```

## 🎯 核心指标设计 (客观数据字段)

### 📊 **四大核心字段** (纯客观数据)

#### 1. 📦 基础OBV指标组 (2个)
- **OBV**: 累积能量潮指标值 *(资金流向基础数据)*
- **OBV_MA10**: OBV的10日移动平均 *(趋势平滑数据)*

#### ⚙️ **计算逻辑**
```python
# 累积计算OBV (标准算法)
OBV[0] = 成交量[0]  # 初始值设为首日成交量
for i in range(1, len(data)):
    if 收盘价[i] > 收盘价[i-1]:
        OBV[i] = OBV[i-1] + 成交量[i]
    elif 收盘价[i] < 收盘价[i-1]:
        OBV[i] = OBV[i-1] - 成交量[i]
    else:
        OBV[i] = OBV[i-1]

# OBV移动平均 (简单移动平均)
OBV_MA10[i] = mean(OBV[i-9:i+1])
```

#### 2. 📈 OBV变化率指标组 (2个)  
- **OBV_CHANGE_5**: OBV的5日变化率 *(短期动量数据)*
- **OBV_CHANGE_20**: OBV的20日变化率 *(中期趋势数据)*

#### ⚙️ **计算逻辑**
```python
# OBV变化率计算 (客观数值)
OBV_CHANGE_5 = (OBV[i] - OBV[i-5]) / abs(OBV[i-5] + 1e-8) * 100
OBV_CHANGE_20 = (OBV[i] - OBV[i-20]) / abs(OBV[i-20] + 1e-8) * 100

# 数值范围: -∞ ~ +∞ (不进行人为标准化)
# 正值表示资金净流入，负值表示资金净流出
```

## 📊 客观数据使用指南

### 🔬 **数据解读原则**
OBV指标提供纯客观的数据输出，不进行主观评分。用户可根据具体需求自行分析判断：

### 📈 **基础数据解读**

#### OBV数值含义
- **正值**: 累积期间资金净流入占优
- **负值**: 累积期间资金净流出占优
- **绝对值大小**: 反映资金流向的累积强度

#### OBV_MA10作用
- **平滑趋势**: 减少单日波动的干扰
- **趋势方向**: OBV > OBV_MA10表示近期资金流入趋势
- **支撑阻力**: MA10可能成为OBV的支撑或阻力位

#### 变化率数据含义
- **OBV_CHANGE_5**: 
  - 正值表示5日内资金净流入
  - 数值越大，短期资金流入越强
  - 适合捕捉短期资金动向
  
- **OBV_CHANGE_20**:
  - 正值表示20日内资金净流入  
  - 数值越大，中期资金流入越强
  - 适合判断中期资金趋势

### 🚨 **使用注意事项**

#### 数据局限性
- **累积特性**: OBV是累积指标，受历史数据影响
- **相对性质**: 绝对数值意义有限，主要看趋势变化
- **ETF特殊性**: 申购赎回机制可能影响成交量统计

#### 建议分析方法
- **趋势分析**: 关注OBV与OBV_MA10的相对位置
- **动量分析**: 观察OBV_CHANGE_5和OBV_CHANGE_20的变化
- **比较分析**: 不同ETF间OBV变化率的对比
- **时间序列**: 追踪OBV指标的历史变化轨迹

## 📋 中国ETF市场应用策略

### 🎯 **1. 宽基指数ETF策略**
- **沪深300ETF**: OBV与大盘资金流向高度相关，准确性较高
- **中证500ETF**: 权重适度分散，OBV信号相对稳定
- **建议阈值**: 标准阈值适用，重点关注`OBV_DIVERGENCE < 20`

### 🏭 **2. 行业主题ETF策略**  
- **科技类ETF**: 受政策和市场情绪影响大，背离容忍度提高到30
- **消费类ETF**: 相对稳定，可使用标准阈值
- **周期类ETF**: 需结合宏观周期，OBV单独使用效果一般

### 💰 **3. 中小盘ETF策略**
- **流动性考量**: `成交量 < 1000万` 的ETF谨慎使用OBV
- **套利影响**: 关注申购赎回对OBV的扰动
- **建议**: 优先选择`OBV_TREND_STRENGTH > 50`的ETF

## 📊 系统输出格式

### 🎯 **4个核心字段CSV输出**
```csv
code,date,obv,obv_ma10,obv_change_5,obv_change_20,calc_time
```

### 📝 **字段详细说明**
- `code`: ETF代码 (不含交易所后缀)
- `date`: 计算日期 (YYYY-MM-DD格式)  
- `obv`: 累积能量潮指标值 (8位小数精度)
- `obv_ma10`: OBV的10日移动平均 (8位小数精度)
- `obv_change_5`: OBV的5日变化率 (%)
- `obv_change_20`: OBV的20日变化率 (%)
- `calc_time`: 计算时间戳

### 📈 **数据格式示例**
```csv
159001,2025-07-26,1248567.89123456,1156789.12345678,15.67890123,-8.34567890,2025-07-26 18:31:39
```

### 📊 **数据示例解读**
- `OBV`: 1,248,567.89 - 累积资金流向为正，历史净流入
- `OBV_MA10`: 1,156,789.12 - 10日平均值，OBV当前高于均线
- `OBV_CHANGE_5`: 15.68% - 5日内资金流入加速
- `OBV_CHANGE_20`: -8.35% - 20日内整体资金流出趋势

## 🎯 客观数据筛选参考

### 📊 **数据筛选思路** (仅供参考)
基于客观数据的一些常用筛选思路，用户可自行调整：

```python
# 资金流入趋势筛选
def inflow_trend_filter(data):
    return (
        data['obv'] > data['obv_ma10'] and      # OBV高于均线
        data['obv_change_5'] > 0 and            # 5日内资金净流入
        data['obv_change_20'] > 0               # 20日内资金净流入
    )

# 短期活跃筛选  
def short_term_active_filter(data):
    return (
        abs(data['obv_change_5']) > 10 and      # 5日变化超过10%
        data['obv'] > data['obv_ma10']          # 维持上升趋势
    )

# 中期稳定筛选
def medium_term_stable_filter(data):
    return (
        data['obv_change_20'] > 5 and           # 20日内稳定流入
        abs(data['obv_change_5']) < 20          # 短期波动可控
    )
```

### 🔄 **组合分析建议**
- **OBV + RSI**: 资金流向确认+超买超卖判断
- **OBV + MACD**: 成交量验证+趋势确认
- **OBV + 价量配合度**: 双重成交量分析验证
- **多ETF对比**: 相同时期不同ETF的OBV表现对比

## ⚠️ 使用注意事项

### 🚨 **中国市场特殊性**
1. **T+1交易制度**: 信号确认需要延后1个交易日
2. **涨跌停限制**: 极端情况下OBV可能出现异常累积
3. **ETF套利机制**: 申购赎回会影响OBV计算的准确性
4. **节假日效应**: 长假前后成交量异常，需要平滑处理

### 📊 **数据质量要求**
- **最少数据量**: 至少30个交易日数据用于计算移动平均
- **异常值处理**: 成交量为0或异常巨量的交易日需要特殊处理
- **停牌影响**: 停牌期间OBV保持不变，复牌后需要重新评估

### 🔧 **参数优化建议**
- **移动平均天数**: 可根据ETF特性调整为5日、10日或20日
- **背离检测周期**: 建议10-20个交易日，过短易产生噪音
- **信号评分权重**: 可根据历史回测结果动态调整

## 🏆 系统优势

### 📈 **技术特色**
- **8位小数精度**: 满足专业量化交易精度要求
- **双门槛处理**: 3000万/5000万门槛ETF分别优化
- **智能缓存系统**: 96%+缓存命中率，增量计算
- **异常值检测**: 自动识别和处理成交量异常

### ⚡ **性能优化**
- **向量化计算**: 批量处理500+ ETF，提高计算效率
- **内存优化**: 滑动窗口计算，控制内存占用
- **并行处理**: 支持多进程并行计算

## 📊 数据依赖最小化

### 🎯 **核心依赖** (仅3个字段)
- **收盘价**: 计算价格变化方向，判断成交量正负归属
- **成交量**: OBV累积计算的基础数据，必须为正值
- **历史数据**: 计算移动平均和变化率需要足够的历史数据

### 📋 **数据质量要求**
- **最少数据量**: 至少21个交易日(计算20日变化率需要)
- **数据连续性**: 停牌或缺失数据会影响累积计算准确性
- **成交量有效性**: 异常巨量或零成交量需要特殊处理

## 🔥 计算优先级
⭐ **第二优先级**: OBV作为成交量指标的核心组件，是验证价格趋势和识别资金流向的重要工具，建议在RSI系统之后优先实现。

---

**📊 系统状态**: 🔧 设计完成 | **🚀 实现状态**: ⏳ 待开发 | **📅 最后更新**: 2025-07-27 