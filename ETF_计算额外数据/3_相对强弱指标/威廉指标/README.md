# 威廉指标 (Williams %R)

## 指标概述
威廉指标(%R)由拉里·威廉姆斯(Larry Williams)于1973年开发，是一个动量振荡器，用于衡量价格在指定时期内的相对位置。该指标通过计算收盘价与最高最低价的关系，提供客观的超买超卖数值，为ETF筛选提供量化依据。

## 包含指标

### 核心威廉指标  
- **wr_9**: 9日威廉指标 - 短期数据
- **wr_14**: 14日威廉指标 - 标准周期
- **wr_21**: 21日威廉指标 - 中期数据

### 差值与变化率指标
- **wr_diff_9_21**: WR9与WR21的差值
- **wr_range**: 威廉指标波动范围(最近5日)
- **wr_change_rate**: 相对前一日的变化率

## 计算公式

### 威廉指标基础计算
```
%R = (Hn - C) / (Hn - Ln) × (-100)

其中：
C  = 当日收盘价
Hn = N日内最高价  
Ln = N日内最低价
N  = 计算周期参数

取值范围：-100 到 0
```

### 衍生指标计算
```
wr_diff_9_21 = wr_9 - wr_21
wr_range = max(WR_5日) - min(WR_5日)  
wr_change_rate = (今日WR - 昨日WR) / |昨日WR| × 100
```

## 数据特征分析

### 数值范围特征
- **超买区域**: %R > -20 (接近0，价格接近阶段最高价)
- **中性区域**: -80 < %R < -20 (价格在正常波动范围)
- **超卖区域**: %R < -80 (接近-100，价格接近阶段最低价)

### 指标敏感度对比
```
周期越短，敏感度越高:
WR9  > WR14 > WR21 （敏感度递减）

差值可作为趋势判断:
wr_diff_9_21 > 0  → 短期相对超买
wr_diff_9_21 < 0  → 短期相对超卖
```

### 波动范围分析
- **wr_range**: 反映最近5日指标波动程度
  - 越大表示波动越剧烈
  - 越小表示波动越温和

### 变化率分析  
- **wr_change_rate**: 反映指标的日间变化速度
  - 正值: 指标上升(相对变强)
  - 负值: 指标下降(相对变弱)
  - 绝对值越大表示变化越剧烈

## 数据计算实例

### 基础计算示例
```python
# 威廉指标计算
def calculate_williams_r(high, low, close, period):
    """
    计算威廉指标
    """
    highest_high = high.rolling(period).max()
    lowest_low = low.rolling(period).min()
    
    wr = (highest_high - close) / (highest_high - lowest_low) * -100
    return wr.round(8)  # 8位小数精度

# 差值计算
def calculate_wr_diff(wr_9, wr_21):
    """
    计算威廉指标差值
    """
    diff = wr_9 - wr_21
    return diff.round(8)

# 波动范围计算
def calculate_wr_range(wr, period=5):
    """
    计算指定期间内的波动范围
    """
    rolling_max = wr.rolling(period).max()
    rolling_min = wr.rolling(period).min()
    wr_range = rolling_max - rolling_min
    return wr_range.round(8)

# 变化率计算
def calculate_wr_change_rate(wr):
    """
    计算日间变化率
    """
    change_rate = (wr - wr.shift(1)) / abs(wr.shift(1)) * 100
    return change_rate.round(8)
```

## 参数设置说明

### 短期参数 (WR9)
- **计算周期**: 9个交易日
- **敏感度**: 高，对价格变化反应迅速
- **数据特点**: 波动较大，噪音相对较多
- **适用情况**: 短期动量分析和筛选

### 标准参数 (WR14)  
- **计算周期**: 14个交易日
- **敏感度**: 中等，平衡性较好
- **数据特点**: 相对稳定，国际通用标准
- **适用情况**: 一般筛选和分析，使用最广泛

### 中期参数 (WR21) 
- **计算周期**: 21个交易日 (约一个月)
- **敏感度**: 较低，信号相对稳定
- **数据特点**: 平滑度高，趋势性明显
- **适用情况**: 中期趋势分析和筛选

## 数据质量要求

### 计算数据需求
- **最少数据量**: 21个交易日(满足WR21计算)
- **建议数据量**: 60个交易日(保证计算稳定性)
- **数据精度**: 8位小数
- **日期格式**: YYYY-MM-DD

### 数据缺失处理
- **停牌日**: 跳过计算，保持前一日数值
- **新上市ETF**: 等待数据稳定后再计算
- **数据异常**: 自动检测和标记异常值

### 计算性能指标
- **单ETF计算时间**: < 10ms
- **批量处理能力**: 500+ ETF/分钟
- **内存占用**: < 100MB
- **缓存命中率**: 95%+

## 注意事项

### 1. 数据计算限制
- **新上市ETF**: 历史数据不足，指标可能不稳定
- **停牌复牌**: 价格不连续会影响计算精度
- **数据缺失**: 需要对缺失数据进行适当处理

### 2. 指标特性限制
- **滞后性**: 威廉指标基于历史数据，存在滞后性
- **极端值**: 在强趋势中可能长期处于极端区域
- **敏感度**: 短周期指标对噪音更敏感

### 3. 使用场景限制
- **仅作筛选参考**: 不应单独作为交易决策依据
- **结合其他指标**: 需要与趋势、成交量等指标综合分析
- **市场环境敏感**: 不同市场环境下效果差异较大

## 筛选应用场景

### 适用的筛选情况
- **超买超卖筛选**: 识别处于极端位置的ETF
- **波动程度筛选**: 通过wr_range识别波动程度
- **趋势强度筛选**: 通过wr_diff_9_21判断趋势一致性
- **动量筛选**: 通过wr_change_rate识别加速或减速ETF
- **稳定性筛选**: 排除数据异常或不稳定的ETF

### 筛选组合示例
```
反转机会筛选:
- wr_14 < -80 (超卖区域)
- wr_change_rate > 5 (指标开始反弹)

强势筛选:
- wr_diff_9_21 > 10 (短期强于中期)
- wr_9 > -50 (短期指标健康)

稳定性筛选:
- wr_range < 20 (波动相对温和)
- abs(wr_change_rate) < 10 (变化温和)
```

## 输出字段

### 威廉指标数据字段
```csv
code,date,wr_9,wr_14,wr_21,wr_diff_9_21,wr_range,wr_change_rate
```

#### 字段说明
- `code`: ETF代码
- `date`: 计算日期 (YYYY-MM-DD格式)
- `wr_9`: 9日威廉指标值 (范围: -100 到 0)
- `wr_14`: 14日威廉指标值 (范围: -100 到 0)
- `wr_21`: 21日威廉指标值 (范围: -100 到 0)
- `wr_diff_9_21`: WR9与WR21的差值
- `wr_range`: 最近5日威廉指标波动范围
- `wr_change_rate`: 威廉指标日变化率 (%)

## 系统集成要求

### 核心功能实现
1. **基础计算**: 实现wr_9, wr_14, wr_21三个核心指标
2. **差值计算**: 实现wr_diff_9_21的差值计算
3. **范围计算**: 实现wr_range的滚动范围计算
4. **变化率计算**: 实现wr_change_rate的日间变化计算

### 数据存储要求
- **文件格式**: CSV格式，低空间占用
- **字段数量**: 6个数据字段 + 2个基础字段
- **存储空间**: 每个ETF约100KB(一年数据)
- **更新频率**: 日频更新，增量计算

### 性能目标
- **计算速度**: 500+ ETF/分钟
- **内存占用**: < 100MB
- **缓存命中**: 95%+
- **数据精度**: 8位小数

---

**威廉指标系统**: ✅ 数据计算完整 | ⚙️ 字段设计简洁 | 📈 筛选功能齐全