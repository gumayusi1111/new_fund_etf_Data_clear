# ETF初筛判断逻辑设计文档

## 📋 **设计原则**

### **核心约束**
- ✅ **严格限制**：仅使用11个基础字段进行筛选
- ✅ **业绩中立**：不因短期涨跌表现作为剔除依据
- ✅ **容错机制**：允许偶发异常，使用滚动窗口平滑
- ✅ **可执行性**：所有判断逻辑基于现有数据直接计算

### **11个基础字段**
- 标识类：`代码`、`日期`
- 价格类：`开盘价`、`最高价`、`最低价`、`收盘价`、`上日收盘`
- 变动类：`涨跌`、`涨幅%`
- 流动性：`成交量(手数)`、`成交额(千元)`

---

## 🎯 **六大筛选维度**

### **1️⃣ 流动性门槛筛选（最重要）**

#### **基础要求**
```
观察期：最近30个交易日
- 日均成交额 ≥ 动态阈值（默认5000万元）
- 日均成交量 ≥ 成交额阈值/平均价格
- 零成交量天数 ≤ 3天
- 连续零成交天数 ≤ 2天
```

#### **质量检查**
```
- 单日最大成交额 ≤ 日均成交额 × 5（防止虚假流动性）
- 成交价格匹配性：成交额/成交量 与 OHLC均价 差异 < 5%
- 动态阈值：max(5000万, 全市场ETF成交额30%分位数)
```

#### **判断逻辑**
- 不满足基础要求 → **直接剔除**
- 存在质量问题 → **标记观察**

---

### **2️⃣ 异常波动检测（分类处理）**

#### **分类标准**
```python
# 根据ETF类型设定不同异常阈值
普通ETF（宽基、行业）：单日涨跌幅 ≤ ±10%
杠杆ETF（2X、3X）：单日涨跌幅 ≤ ±20%
商品ETF（黄金、原油）：单日涨跌幅 ≤ ±15%
```

#### **检查项目**
```
观察期：最近30个交易日
- 异常涨跌天数：超过阈值的天数 ≤ 2天
- 异常振幅天数：日内振幅 > 15% 的天数 ≤ 2天
  振幅 = (最高价-最低价)/上日收盘 × 100%
- 闪崩检测：单日跌幅 > 15% 且 当日成交额 < 平均成交额 × 0.5
```

#### **判断逻辑**
- 多项异常 → **剔除**
- 单项异常 → **标记观察**

---

### **3️⃣ 价格质量检查（全面验证）**

#### **OHLC逻辑检查**
```
基础逻辑：最低价 ≤ 开盘价,收盘价 ≤ 最高价
跳空检查：|开盘价-上日收盘| / 上日收盘 < 20%
一致性检查：成交量=0时，开=高=低=收
极端检查：识别一字涨停/跌停的合理性
```

#### **价格活跃度检查**
```
观察期：最近10个交易日
- 价格变化率 ≥ 0.001（防止微僵化）
  价格变化率 = std(收盘价) / mean(收盘价)
- 连续相同收盘价 ≤ 3天
- 最近10天至少有5天价格有变化
```

#### **价格合理性检查**
```
- 收盘价 > 0.01元（基本要求）
- 收盘价 < 500元（排除异常高价）
- 价格不应长期僵化后突然异动
```

---

### **4️⃣ 数据质量验证（完整性保障）**

#### **字段完整性**
```
必要字段检查：
- 代码、日期不能缺失
- OHLC价格数据完整
- 成交量、成交额数据完整
- 缺失率 < 5%
```

#### **逻辑一致性**
```
数据关系验证：
- 成交量=0 ⟺ 成交额=0
- 涨跌 = 收盘价 - 上日收盘（误差 < 0.01）
- 涨幅% = 涨跌 / 上日收盘 × 100（误差 < 0.1%）
- 成交额(千元) = 成交量(手数) × 平均价格 × 100 / 1000
```

---

### **5️⃣ 特殊情况识别（智能分类）**

#### **ETF类型识别**
```python
# 基于ETF代码或名称特征
货币ETF：价格接近100且波动 < 0.5%
杠杆ETF：名称包含"2X"、"杠杆"、"反向"
分级ETF：名称包含"A"、"B"、"分级"
商品ETF：名称包含"黄金"、"原油"、"商品"
```

#### **市场环境适应**
```
特殊交易日处理：
- 熔断日：放宽异常波动标准
- 节假日前后：允许成交量下降
- 新上市ETF（<30天）：暂不纳入筛选
```

---

### **6️⃣ 风险预警机制（前瞻性识别）**

#### **清盘风险预警**
```
高风险标准：
- 连续30天日均成交额 < 500万元
- 连续60天成交量极度萎缩
- 价格长期脱离合理区间
```

#### **交易风险预警**
```
操作风险：
- 流动性突然恶化
- 价格异常波动增加
- 成交量-成交额匹配异常
```

---

## 📊 **筛选流程与结果**

### **三级筛选流程**
```python
def ETF初筛(etf_data):
    """
    第一级：硬性门槛筛选
    - 流动性不足 → 直接剔除
    - 数据质量差 → 直接剔除
    
    第二级：异常检测
    - 价格异常 → 标记观察
    - 波动异常 → 标记观察
    
    第三级：风险评估
    - 特殊类型识别
    - 风险等级评定
    """
    
    # 流动性检查
    if not 通过流动性门槛():
        return "剔除", "流动性不足"
    
    # 数据质量检查
    质量问题 = 数据质量检查()
    if len(质量问题) > 2:
        return "剔除", "数据质量差"
    
    # 异常检测
    异常标记 = 异常波动检测() + 价格异常检测()
    
    # 综合判断
    if len(异常标记) == 0:
        return "通过", "优质ETF"
    elif len(异常标记) == 1:
        return "观察", "轻微异常"
    else:
        return "剔除", "多项异常"
```

### **预期筛选结果**
- **通过率**：60-70%的ETF通过筛选
- **剔除对象**：迷你ETF、僵尸ETF、异常ETF
- **观察对象**：存在轻微问题但可关注的ETF
- **保留对象**：主流活跃ETF、正常交易的细分领域ETF

---

## 🛠️ **实施要点**

### **参数配置**
- **观察期**：30个交易日（约1.5个月）
- **更新频率**：每日更新，每月调整阈值
- **容错比例**：允许10%的异常天数

### **动态调整机制**
- 阈值根据市场整体情况动态调整
- 特殊市场环境下适当放宽标准
- 新产品给予适应期

### **质量保障**
- 每月回测筛选效果
- 定期检查剔除ETF的后续表现
- 持续优化判断逻辑

---

## 📈 **预期效果**

通过这套初筛逻辑，能够：
1. **有效剔除**流动性不足、数据异常的问题ETF
2. **保留主流**活跃ETF，为后续深度分析提供优质样本
3. **识别风险**，避免选入即将清盘或存在重大缺陷的ETF
4. **适应性强**，能够处理不同类型ETF的特殊情况

最终目标：**获得一个相对干净、可靠的ETF候选池，为后续策略开发奠定坚实基础**。
